import rclpy
from rclpy.node import Node
from rclpy.action import ActionClient
from geometry_msgs.msg import PoseStamped
from nav2_msgs.action import NavigateToPose
from ament_index_python.packages import get_package_share_directory
import yaml
import os

class NavigationClient(Node):
    def __init__(self):
        super().__init__('navigation_client')
        self._action_client = ActionClient(self, NavigateToPose, 'navigate_to_pose')
        
        # YAML 경로 설정
        possible_paths = [
            os.path.expanduser('~/Desktop/GitHub/visually-impaired-navigation-robot/src/blind_nav_system/config/location.yaml'),
            os.path.join(get_package_share_directory('blind_nav_system'), 'config', 'location.yaml') if 'blind_nav_system' in os.popen('ros2 pkg list').read() else ""
        ]
        
        self.yaml_path = None
        for path in possible_paths:
            if path and os.path.exists(path):
                self.yaml_path = path
                break
        
        if not self.yaml_path:
            self.get_logger().error('location.yaml 파일을 찾을 수 없습니다!')
        else:
            self.get_logger().info(f'설정 파일 로드 완료: {self.yaml_path}')

    def load_location(self, name):
        if not self.yaml_path: return None
        try:
            with open(self.yaml_path, 'r') as f:
                data = yaml.safe_load(f)
            return data['locations'].get(name)
        except Exception as e:
            return None

    def send_goal(self, location_name):
        loc = self.load_location(location_name)
        if not loc:
            return False

        goal_msg = NavigateToPose.Goal()
        goal_msg.pose.header.frame_id = "map"
        goal_msg.pose.header.stamp = self.get_clock().now().to_msg()
        goal_msg.pose.pose.position.x = float(loc['x'])
        goal_msg.pose.pose.position.y = float(loc['y'])
        goal_msg.pose.pose.orientation.w = float(loc.get('w', 1.0))

        self.get_logger().info(f'[{location_name}] 서버 연결 대기 중 (최대 20초)...')
        
        # 통합 환경에서는 wait_for_server가 더 민감할 수 있어 시간을 충분히 줍니다.
        if not self._action_client.wait_for_server(timeout_sec=20.0):
            self.get_logger().error('Nav2 서버를 찾을 수 없습니다!')
            return False

        self.get_logger().info(f'서버 연결 성공!')
        self._send_goal_future = self._action_client.send_goal_async(goal_msg)
        return True

def main(args=None):
    rclpy.init(args=args)
    nav_client = NavigationClient()
    nav_client.send_goal('point_b')
    rclpy.spin(nav_client)
    rclpy.shutdown()